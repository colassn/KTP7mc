<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆäººå°çå“ç®¡ç†</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #000; color: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        #loader { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ec4899; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .bg-anim { background: radial-gradient(circle at 50% 10%, #1f1033, #000000 80%); position: fixed; inset: 0; z-index: -1; }
        .glass-card { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 30px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="margin-top:20px; color:#ec4899; font-weight:bold;">SYSTEM LOADING...</div>
        <div id="loader-tips" style="margin-top:10px; color:gray; font-size:12px;">æ­£åœ¨å•Ÿå‹•...</div>
    </div>
    
    <div id="root"></div>

    <script>
        // å¼·åˆ¶éŒ¯èª¤é¡¯ç¤º
        window.onerror = function(msg, url, line) {
            const l = document.getElementById('loader');
            l.innerHTML = `<div style="color:red; padding:20px; text-align:center;">
                <h2 style="font-size:20px; margin-bottom:10px;">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h2>
                <p>${msg}</p>
                <p style="font-size:12px; color:gray; margin-top:10px;">Line: ${line}</p>
            </div>`;
        };
        setTimeout(() => {
            const l = document.getElementById('loader');
            if(l && l.style.display!=='none') document.getElementById('loader-tips').innerHTML = "è¼‰å…¥éä¹…... <br>è«‹æª¢æŸ¥ç¶²è·¯ï¼Œæˆ– Firebase è¨­å®šæ˜¯å¦æ­£ç¢º";
        }, 5000);
    </script>

    <script type="text/babel">
        // ==========================================
        // âš ï¸ Firebase Config âš ï¸
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyCEM9T47ajTYWYwZO84qRWLlzfYVZVkmFw",
          authDomain: "machine7-1316f.firebaseapp.com",
          projectId: "machine7-1316f",
          storageBucket: "machine7-1316f.firebasestorage.app",
          messagingSenderId: "468967450902",
          appId: "1:468967450902:web:2c81e35e58f0dd36d4c837",
          measurementId: "G-NQXGNRRH3J"
        };
        // ==========================================

        try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); }
        const db = firebase.firestore();
        const auth = firebase.auth();
        auth.signInAnonymously().catch(e => console.error("Auth Error:", e));

        const { useState, useEffect } = React;

        // --- å…§å»ºåœ–æ¨™ç³»çµ± ---
        const ICONS = {
            Zap: <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />,
            Lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>,
            Unlock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 9.9-1" /></>,
            Gift: <><polyline points="20 12 20 22 4 22 4 12" /><rect x="2" y="7" width="20" height="5" /><line x1="12" y1="22" x2="12" y2="7" /><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z" /><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z" /></>,
            Check: <polyline points="20 6 9 17 4 12" />,
            CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></>,
            Ghost: <path d="M9 22l1-2.5L12 22l2-2.5L16 22l-1-2.5 2.5-1.5a9 9 0 1 0-14.5-3.5L3 16l3 2.5.5 3.5" />,
            Trash2: <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></>,
            Plus: <><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></>,
            PlusCircle: <><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="16" /><line x1="8" y1="12" x2="16" y2="12" /></>,
            Settings: <><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></>,
            Grid: <><rect x="3" y="3" width="7" height="7" /><rect x="14" y="3" width="7" height="7" /><rect x="14" y="14" width="7" height="7" /><rect x="3" y="14" width="7" height="7" /></>
        };

        const Icon = ({ name, size=24, className, style }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}>
                {ICONS[name] || <circle cx="12" cy="12" r="10" />}
            </svg>
        );

        const COLORS = {
            pink: {bg:'#ec4899', glow:'rgba(236,72,153,0.3)'},
            purple: {bg:'#a855f7', glow:'rgba(168,85,247,0.3)'},
            cyan: {bg:'#06b6d4', glow:'rgba(6,182,212,0.3)'},
            yellow: {bg:'#eab308', glow:'rgba(234,179,8,0.3)'},
            green: {bg:'#22c55e', glow:'rgba(34,197,94,0.3)'},
            red: {bg:'#ef4444', glow:'rgba(239,68,68,0.3)'}
        };

        const WA_MSG = `ä½ å¥½ï¼çå“å·²æ´¾é€ï¼å¦‚æœ‰ä»»ä½•å•é¡Œæ­¡è¿è©¢å•æˆ‘å€‘è¬è¬ğŸ™ğŸ»\n\nğŸ”¹åœ°å€ï¼š\n1ï¸âƒ£é¦™æ¸¯ è§€å¡˜ é–‹æºé“60è™Ÿ é§±é§æ¼†ä¸‰åº§å¾Œå·· B5é‹ªé–£æ¨“\n2ï¸âƒ£ é¦™æ¸¯ è§€å¡˜å»£å ´ ä¸€æ¨“ 15D2é‹ª\nâœ¨æ‹›å°ä¸»ä¸­âœ¨`;

        function App() {
            const [isAdmin, setIsAdmin] = useState(false);
            const [showPin, setShowPin] = useState(false);
            const [pin, setPin] = useState('');
            const [tab, setTab] = useState('list');
            const [winners, setWinners] = useState([]);
            const [prizes, setPrizes] = useState([]);
            
            // Forms
            const [phone, setPhone] = useState('');
            const [selPrize, setSelPrize] = useState('');
            const [newType, setNewType] = useState('');
            const [newColor, setNewColor] = useState('pink');

            useEffect(() => {
                document.getElementById('loader').style.display = 'none';

                const u1 = db.collection('prize_types').onSnapshot(s => {
                    const d = s.docs.map(i=>({id:i.id,...i.data()}));
                    d.sort((a,b)=>(a.timestamp?.seconds||0)-(b.timestamp?.seconds||0));
                    setPrizes(d);
                }, err => console.error(err));

                const u2 = db.collection('winners').onSnapshot(s => {
                    const d = s.docs.map(i=>({id:i.id,...i.data()}));
                    d.sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
                    setWinners(d);
                }, err => console.error(err));

                return () => { u1(); u2(); };
            }, []);

            const addW = async () => {
                if(phone.length!=8 || !selPrize) return alert("è³‡æ–™ä¸å®Œæ•´ (é›»è©±éœ€ç‚º8ä½)");
                const p = prizes.find(x=>x.id===selPrize);
                try {
                    await db.collection('winners').add({
                        phone, prizeId:p.id, prizeName:p.name, prizeColor:p.color, isClaimed:false,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setPhone(''); alert("ç™¼é€æˆåŠŸ");
                } catch(e) { alert("ç™¼é€å¤±æ•—: "+e.message); }
            };

            const clickCard = (w) => {
                if(!isAdmin) return;
                if(!w.isClaimed) {
                    if(confirm("ç¢ºèªå·²æ´¾çï¼Ÿ")) {
                        if(confirm("æ´¾çå¾Œåˆªé™¤å¡ç‰‡ï¼Ÿ (å–æ¶ˆ=ä¿ç•™)")) db.collection('winners').doc(w.id).delete();
                        else db.collection('winners').doc(w.id).update({isClaimed:true});
                    }
                } else {
                    if(confirm("æ¢å¾©ç‚ºæœªé ˜å–ï¼Ÿ")) db.collection('winners').doc(w.id).update({isClaimed:false});
                }
            };

            return (
                <div className="bg-anim min-h-screen pb-24">
                    {/* Header */}
                    <div className="sticky top-0 z-50 bg-black/80 backdrop-blur border-b border-white/10 p-4 flex justify-between items-center">
                        <div className="flex items-center gap-2 font-bold text-lg text-white">
                            <div className="text-pink-500"><Icon name="Zap"/></div> æˆäººå°çå“ç®¡ç†
                        </div>
                        <button onClick={()=>isAdmin?setIsAdmin(false):setShowPin(true)} className="p-2 bg-white/10 rounded-full">
                            <Icon name={isAdmin?"Unlock":"Lock"} className={isAdmin?"text-green-400":"text-gray-400"}/>
                        </button>
                    </div>

                    <div className="p-4 max-w-lg mx-auto">
                        {/* LIST TAB */}
                        {tab==='list' && (
                            <div className="grid grid-cols-1 gap-4">
                                {winners.length===0 && <div className="text-center py-20 opacity-50"><Icon name="Ghost" size={48} className="mx-auto mb-2"/><p>æš«ç„¡è³‡æ–™</p></div>}
                                {winners.map(w => {
                                    const c = COLORS[w.prizeColor]||COLORS.pink;
                                    const waLink = `https://wa.me/852${w.phone}?text=${encodeURIComponent(WA_MSG)}`;
                                    
                                    return (
                                        <div key={w.id} className={`glass-card rounded-2xl relative overflow-hidden transition-all ${w.isClaimed?'grayscale opacity-40':''}`}
                                            style={{boxShadow: w.isClaimed?'none':`0 0 15px ${c.glow}`}}>
                                            <div style={{position:'absolute',left:0,top:0,bottom:0,width:'5px',background:c.bg}}></div>
                                            
                                            {/* ä¸»è¦é»æ“Šå€ */}
                                            <div className="p-5 flex justify-between items-center cursor-pointer" onClick={()=>clickCard(w)}>
                                                <div>
                                                    <div className="text-xs font-bold px-2 py-0.5 rounded inline-block mb-1 border" style={{borderColor:c.bg, color:c.bg}}>{w.prizeName}</div>
                                                    <div className="text-4xl font-mono font-bold tracking-tighter">{w.phone}</div>
                                                </div>
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${w.isClaimed?'bg-gray-700':'bg-white/10'}`}>
                                                    <Icon name={w.isClaimed?"Check":"Gift"} style={{color:w.isClaimed?'gray':c.bg}}/>
                                                </div>
                                            </div>

                                            {/* WhatsApp æŒ‰éˆ• */}
                                            <div className="px-5 pb-5">
                                                <a href={waLink} target="_blank" 
                                                   className="flex items-center justify-center gap-2 w-full py-2 bg-green-600 rounded-lg text-white font-bold text-sm hover:bg-green-500 active:scale-95 transition-all"
                                                   onClick={(e)=>e.stopPropagation()}>
                                                    WhatsApp é€šçŸ¥é ˜ç
                                                </a>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        )}

                        {/* ADD TAB */}
                        {tab==='add' && isAdmin && (
                            <div className="glass-card p-6 rounded-3xl space-y-5">
                                <h2 className="font-bold text-lg flex gap-2"><Icon name="PlusCircle" className="text-pink-500"/> ç™¼é€å¡ç‰‡</h2>
                                <input value={phone} onChange={e=>setPhone(e.target.value.replace(/\D/g,''))} type="tel" maxLength={8} className="w-full bg-black/50 p-4 rounded-xl text-center text-2xl font-mono border border-white/20 outline-none focus:border-pink-500 tracking-widest text-white" placeholder="è«‹è¼¸å…¥8ä½é›»è©±è™Ÿç¢¼"/>
                                <div className="grid grid-cols-2 gap-2">
                                    {prizes.map(p => {
                                        const c = COLORS[p.color]||COLORS.pink;
                                        return (
                                            <button key={p.id} onClick={()=>setSelPrize(p.id)} className={`p-3 rounded-xl border text-left font-bold transition-all relative overflow-hidden ${selPrize===p.id?'border-white bg-white/10':'border-white/10 opacity-60'}`}>
                                                <div style={{color:c.bg}}>{p.name}</div>
                                                {selPrize===p.id && <div className="absolute right-2 top-2"><Icon name="CheckCircle" size={14} style={{color:c.bg}}/></div>}
                                            </button>
                                        )
                                    })}
                                </div>
                                <button onClick={addW} className="w-full bg-pink-600 p-3 rounded-xl font-bold shadow-[0_0_15px_#ec4899]">ç¢ºèªç™¼é€</button>
                            </div>
                        )}

                        {/* CONFIG TAB */}
                        {tab==='config' && isAdmin && (
                            <div className="glass-card p-6 rounded-3xl space-y-4">
                                <div className="flex gap-2">
                                    <input value={newType} onChange={e=>setNewType(e.target.value)} className="flex-1 bg-black/50 p-2 rounded-lg border border-white/20 outline-none" placeholder="æ–°çé …åç¨±"/>
                                    <button onClick={()=>{if(newType){db.collection('prize_types').add({name:newType,color:newColor,timestamp:firebase.firestore.FieldValue.serverTimestamp()});setNewType('')}}} className="bg-pink-600 px-4 rounded-lg font-bold">+</button>
                                </div>
                                <div className="flex gap-2 mb-4">
                                    {Object.keys(COLORS).map(k=><button key={k} onClick={()=>setNewColor(k)} style={{background:COLORS[k].bg}} className={`w-8 h-8 rounded-full border-2 ${newColor===k?'border-white':'border-transparent'}`}></button>)}
                                </div>
                                <div className="space-y-2">
                                    {prizes.map(p=>(
                                        <div key={p.id} className="flex justify-between items-center bg-white/5 p-3 rounded-lg border border-white/5">
                                            <span style={{color:(COLORS[p.color]||COLORS.pink).bg}}>â— {p.name}</span>
                                            <button onClick={()=>db.collection('prize_types').doc(p.id).delete()} className="text-gray-500"><Icon name="Trash2" size={16}/></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* PIN Pad */}
                    {showPin && (
                        <div className="fixed inset-0 bg-black/90 z-[60] flex flex-col justify-center items-center backdrop-blur-sm">
                            <h2 className="text-xl font-bold mb-8 text-pink-500 tracking-widest">SECURITY</h2>
                            <div className="flex gap-2 mb-8">{[0,1,2,3].map(i=><div key={i} className={`w-3 h-3 rounded-full ${pin.length>i?'bg-white':'bg-gray-700'}`}/>)}</div>
                            <div className="grid grid-cols-3 gap-4 w-64">
                                {[1,2,3,4,5,6,7,8,9,'C',0,'Go'].map(k=>(
                                    <button key={k} onClick={()=>{if(k==='C')setPin('');else if(k==='Go'){if(pin==='1234'){setIsAdmin(true);setShowPin(false);setPin('')}else setPin('')}else if(pin.length<4)setPin(p=>p+k)}} className="h-16 rounded-xl bg-white/10 font-bold text-xl active:bg-white/30">{k}</button>
                                ))}
                            </div>
                            <button onClick={()=>setShowPin(false)} className="mt-8 text-gray-500">å–æ¶ˆ</button>
                        </div>
                    )}

                    {/* Navbar */}
                    {isAdmin && (
                        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 flex gap-4 bg-black/80 backdrop-blur border border-white/10 px-6 py-3 rounded-full shadow-2xl z-40">
                            {[{id:'list',i:'Grid'},{id:'add',i:'Plus'},{id:'config',i:'Settings'}].map(t=>(
                                <button key={t.id} onClick={()=>setTab(t.id)} className={`transition-all ${tab===t.id?'text-pink-500 scale-125':'text-gray-500'}`}><Icon name={t.i} size={24}/></button>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


